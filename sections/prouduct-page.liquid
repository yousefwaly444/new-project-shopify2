{% assign current_variant = product.selected_or_first_available_variant %}
{% assign featured_image = current_variant.featured_image | default: product.featured_image %}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
    
    <!-- Left: Image Gallery -->
      
      <div class="relative">
        <!-- Zoom/Search Icon -->
        <button type="button" class="absolute top-4 right-4 z-10 w-10 h-10 bg-black rounded-full flex items-center justify-center text-white hover:bg-gray-800 transition-colors" aria-label="Zoom">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        </button>
        
        <!-- Main Image -->
        <div id="product-main-image" class="aspect-square bg-gray-100 rounded-lg overflow-hidden">
          {% if featured_image %}
            <img src="{{ featured_image | image_url: width: 800 }}" alt="{{ featured_image.alt | escape }}" width="800" height="800" class="w-full h-full object-cover">
          {% else %}
            {{ 'product-1' | placeholder_svg_tag: 'w-full h-full object-cover' }}
          {% endif %}
        </div>
        
        <!-- Thumbnail Gallery -->
        {% if product.images.size > 1 %}
          <div class="flex gap-2 mt-4 overflow-x-auto pb-2">
            {% for image in product.images %}
              <button type="button" class="product-thumb shrink-0 w-16 h-16 rounded-lg overflow-hidden border-2 {% if image == featured_image %}border-black{% else %}border-gray-200{% endif %}" data-image-url="{{ image | image_url: width: 800 }}">
                <img src="{{ image | image_url: width: 100 }}" alt="{{ image.alt | escape }}" width="100" height="100" class="w-full h-full object-cover">
              </button>
            {% endfor %}
          </div>
        {% endif %}
        
        <!-- Carousel Pagination Dots -->
        {% if product.images.size > 1 %}
          <div class="flex justify-center gap-2 mt-4">
            {% for image in product.images %}
              <button type="button" class="product-dot w-2 h-2 rounded-full {% if image == featured_image %}bg-gray-900{% else %}bg-white border border-gray-300{% endif %}" data-index="{{ forloop.index0 }}" aria-label="View image {{ forloop.index }}"></button>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    
    <!-- Right: Product Details -->
    <div class="space-y-6">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900">{{ product.title }}</h1>
      
      <!-- Price -->
      <div class="flex items-baseline gap-3">
        <span class="text-2xl font-bold text-gray-900">{{ current_variant.price | money }}</span>
        {% if current_variant.compare_at_price > current_variant.price %}
          <span class="text-xl text-gray-500 line-through">{{ current_variant.compare_at_price | money }}</span>
        {% endif %}
      </div>
      
      <!-- Stock Status -->
      <div class="flex items-center gap-2">
        {% if current_variant.available %}
          <span class="w-2 h-2 rounded-full bg-green-500"></span>
          <span class="text-gray-900">In Stock</span>
        {% else %}
          <span class="w-2 h-2 rounded-full bg-red-500"></span>
          <span class="text-gray-900">Sold Out</span>
        {% endif %}
      </div>
      <!-- Delivery & Returns badges (blocks) -->
      {% assign badge_blocks = section.blocks | where: 'type', 'badge' %}
      {% if badge_blocks.size > 0 %}
        <div class="space-y-2">
          {% for block in badge_blocks %}
            {% if block.settings.badge_text != blank %}
              <div class="flex items-center gap-2 text-gray-900" {{ block.shopify_attributes }}>
                {% if block.settings.badge_icon != blank %}
                  <img src="{{ block.settings.badge_icon | image_url: width: 20, height: 20 }}" width="20" height="20" alt="" class="shrink-0">
                {% else %}
                  <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                {% endif %}
                <span>{{ block.settings.badge_text }}</span>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}
      
      <!-- Add to Cart Form -->
      <form action="{{ routes.cart_add_url }}" method="post" id="product-form" class="space-y-4 product-add-form">
        <input type="hidden" name="id" id="product-variant-id" value="{{ current_variant.id }}">
        
        <!-- Variant Selector (if multiple) -->
        {% if product.variants.size > 1 %}
          <div>
            <label class="block text-sm font-medium text-gray-900 mb-2">Variant</label>
            <select name="id" id="variant-select" class="w-full border border-gray-300 rounded-lg px-4 py-3">
              {% for variant in product.variants %}
                <option value="{{ variant.id }}" {% unless variant.available %}disabled{% endunless %}>
                  {{ variant.title }} - {{ variant.price | money }}{% unless variant.available %} (Sold out){% endunless %}
                </option>
              {% endfor %}
            </select>
          </div>
        {% endif %}
        
        <!-- Quantity stepper + Add to Cart -->
        <div style="display: flex; flex-direction: row; gap: 12px; align-items: stretch;">
          <div style="display: inline-flex; border: 1px solid #d1d5db; border-radius: 12px; background: #fff; overflow: hidden; flex-shrink: 0;">
            <button type="button" id="qty-minus" style="width: 44px; display: flex; align-items: center; justify-content: center; background: none; border: none; cursor: pointer; font-size: 22px; color: #1f2937; line-height: 1;">−</button>
            <input type="number" name="quantity" id="quantity" value="1" min="1" max="5" class="product-qty-input" style="width: 52px; text-align: center; border: none; border-left: 1px solid #d1d5db; border-right: 1px solid #d1d5db; font-size: 15px; font-weight: 600; -moz-appearance: textfield;">
            <button type="button" id="qty-plus" style="width: 44px; display: flex; align-items: center; justify-content: center; background: none; border: none; cursor: pointer; font-size: 22px; color: #1f2937; line-height: 1;">+</button>
          </div>

          <button type="button" id="add-to-cart-product" class="add-to-cart-btn" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 15px 24px; background: #000; color: #fff; font-weight: bold; font-size: 1rem; border-radius: 12px; border: none; cursor: pointer; white-space: nowrap;" data-variant-id="{{ current_variant.id }}">
            <svg style="width: 20px; height: 20px; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
            Add to cart
          </button>
        </div>
        
        <button type="submit" form="product-form" formaction="{{ routes.cart_add_url }}?return_to=/checkout" name="add" style="width: 100%; margin-top: 12px; padding: 14px 24px; background: #000; color: #fff; font-weight: bold; border-radius: 12px; border: none; cursor: pointer;">
          Buy it now
        </button>
      </form>
      
      <!-- Fragrance Notes -->
      {% assign note_blocks = section.blocks | where: 'type', 'fragrance_note' %}
      {% if note_blocks.size > 0 %}
        <div class="fn-section pt-6 border-t border-gray-200">
          {% if section.settings.fragrance_heading != blank %}
            <h2 class="fn-heading">{{ section.settings.fragrance_heading }}</h2>
          {% endif %}
          <div class="fn-grid">
            {% for block in note_blocks %}
              <div class="fn-card" {{ block.shopify_attributes }}>
                <span class="fn-card__subtitle">{{ block.settings.subtitle }}</span>
                {% if block.settings.icon != blank %}
                  <div class="fn-card__icon">
                    <img
                      src="{{ block.settings.icon | image_url: width: 80, height: 80 }}"
                      alt="{{ block.settings.subtitle | escape }}"
                      width="80"
                      height="80"
                    >
                  </div>
                {% else %}
                  <div class="fn-card__icon fn-card__icon--placeholder">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/></svg>
                  </div>
                {% endif %}
                <span class="fn-card__duration">{{ block.settings.duration }}</span>
                <span class="fn-card__label">{{ block.settings.note_label }}</span>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      <!-- Description -->
      {% if product.description != blank %}
        <div class="pt-6 border-t border-gray-200">
          <h3 class="text-lg font-bold text-gray-900 mb-2">Description</h3>
          <div class="text-gray-600 prose max-w-none">{{ product.description }}</div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
  .product-qty-input::-webkit-outer-spin-button,
  .product-qty-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  #qty-minus:hover, #qty-plus:hover { background: #f3f4f6 !important; }
  .add-to-cart-btn:hover { background: #374151 !important; }

  /* Fragrance Notes */
  .fn-section { margin-top: 0; }
  .fn-heading {
    font-size: 1.25rem;
    font-weight: 700;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: #111827;
    margin-bottom: 1.25rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #111827;
    display: inline-block;
  }
  .fn-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }
  .fn-card {
    background: #1a1a1a;
    border-radius: 1rem;
    padding: 1.25rem 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    text-align: center;
  }
  .fn-card__subtitle {
    font-size: 0.625rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: #d1d5db;
    line-height: 1.4;
    min-height: 2rem;
    display: flex;
    align-items: center;
  }
  .fn-card__icon {
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .fn-card__icon img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  .fn-card__icon--placeholder { color: #fff; }
  .fn-card__duration {
    font-size: 0.75rem;
    color: #9ca3af;
    letter-spacing: 0.05em;
  }
  .fn-card__label {
    font-size: 0.875rem;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: #f9fafb;
    margin-top: 0.25rem;
  }
  @media (max-width: 640px) {
    .fn-grid { grid-template-columns: 1fr; }
    .fn-card__subtitle { min-height: auto; }
  }
</style>
<script>
  (function() {
    const form = document.getElementById('product-form');
    const qtyInput = document.getElementById('quantity');
    const qtyMinus = document.getElementById('qty-minus');
    const qtyPlus = document.getElementById('qty-plus');
    
    if (qtyMinus) qtyMinus.addEventListener('click', () => { qtyInput.value = Math.max(1, parseInt(qtyInput.value) - 1); });
    if (qtyPlus) qtyPlus.addEventListener('click', () => { qtyInput.value = parseInt(qtyInput.value || 1) + 1; });
    
    document.querySelectorAll('.product-thumb').forEach(btn => {
      btn.addEventListener('click', function() {
        const url = this.dataset.imageUrl;
        const mainImg = document.querySelector('#product-main-image img');
        if (mainImg && url) mainImg.src = url;
        document.querySelectorAll('.product-thumb').forEach(b => b.classList.remove('border-black'));
        document.querySelectorAll('.product-dot').forEach(d => { d.classList.remove('bg-gray-900'); d.classList.add('bg-white', 'border', 'border-gray-300'); });
        this.classList.add('border-black');
        const idx = Array.from(document.querySelectorAll('.product-thumb')).indexOf(this);
        const dot = document.querySelector(`.product-dot[data-index="${idx}"]`);
        if (dot) { dot.classList.add('bg-gray-900'); dot.classList.remove('bg-white', 'border', 'border-gray-300'); }
      });
    });
    
    document.querySelectorAll('.product-dot').forEach(btn => {
      btn.addEventListener('click', function() {
        const idx = parseInt(this.dataset.index);
        const thumb = document.querySelectorAll('.product-thumb')[idx];
        if (thumb) thumb.click();
      });
    });
    
    const variantSelect = document.getElementById('variant-select');
    const variantInput = document.getElementById('product-variant-id');
    if (variantSelect && variantInput) {
      variantSelect.addEventListener('change', function() {
        variantInput.value = this.value;
      });
    }
  })();
</script>

{% schema %}
{
  "name": "Product Page",
  "max_blocks": 10,
  "settings": [
    {
      "type": "text",
      "id": "fragrance_heading",
      "label": "Fragrance notes heading",
      "default": "Fragrance Notes"
    }
  ],
  "blocks": [
    {
      "type": "badge",
      "name": "Badge",
      "settings": [
        {
          "type": "image_picker",
          "id": "badge_icon",
          "label": "Icon (optional)"
        },
        {
          "type": "text",
          "id": "badge_text",
          "label": "Badge text",
          "default": "Badge text"
        }
      ]
    },
    {
      "type": "fragrance_note",
      "name": "Fragrance Note Card",
      "settings": [
        {
          "type": "image_picker",
          "id": "icon",
          "label": "Icon image"
        },
        {
          "type": "text",
          "id": "subtitle",
          "label": "Subtitle (e.g. Lightest First Impression)",
          "default": "Lightest First Impression"
        },
        {
          "type": "text",
          "id": "duration",
          "label": "Duration (e.g. 5 – 15 min)",
          "default": "5 – 15 min"
        },
        {
          "type": "text",
          "id": "note_label",
          "label": "Note label (e.g. Top)",
          "default": "Top"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Page",
      "blocks": [
        {
          "type": "badge",
          "settings": {
            "badge_text": "Free express delivery"
          }
        },
        {
          "type": "badge",
          "settings": {
            "badge_text": "Easy return policy"
          }
        },
        {
          "type": "fragrance_note",
          "settings": {
            "subtitle": "Lightest First Impression",
            "duration": "5 – 15 min",
            "note_label": "Top"
          }
        },
        {
          "type": "fragrance_note",
          "settings": {
            "subtitle": "Body of a Perfume",
            "duration": "3 – 5 h",
            "note_label": "Middle"
          }
        },
        {
          "type": "fragrance_note",
          "settings": {
            "subtitle": "Foundation of Fragrance",
            "duration": "8 + h",
            "note_label": "Base"
          }
        }
      ]
    }
  ]
}
{% endschema %}
